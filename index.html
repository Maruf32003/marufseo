<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One Toolkit</title>
    <!-- Favicon from your portfolio -->
    <link rel="icon" href="https://marufusion.rf.gd/wp-content/uploads/2024/10/cropped-Untitled-design-12-small-32x32.png" sizes="32x32">
    
    <!-- 
      Tailwind CSS for styling. 
      If the website appears unstyled after deploying, it means your browser could not fetch this file.
      Please check your internet connection and the browser's developer console for any errors.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JavaScript Libraries for Tools -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Global Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* A dark theme for the body */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
        /* Hide all pages by default */
        .page-content {
            display: none;
        }
        /* Show the active page */
        .page-content.active {
            display: block;
        }
        /* Style for the active navigation link */
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }

        /* --- Styles from Background Remover --- */
        #folder-upload-btn::before, #converter-folder-upload-btn::before {
            content: 'Select Folder';
            position: absolute;
            inset: 0;
            background-color: #4f46e5;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #folder-upload-btn:hover::before, #converter-folder-upload-btn:hover::before {
            background-color: #4338ca;
        }
        .error-message {
            color: #f87171;
            background-color: #450a0a;
            border: 1px solid #ef4444;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        /* --- Styles from File Renamer --- */
        .file-drop-area {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .file-drop-area.drag-over {
            background-color: #e0f2fe;
            border-color: #0284c7;
        }

        /* --- Styles from Duplicate Checker --- */
        #editableInput {
            width: 100%;
            min-height: 200px;
            border: 1px solid #4a5568;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
            outline: none;
            font-size: 14px;
            background-color: #2d3748;
            color: #e2e8f0;
            border-radius: 0.5rem;
        }
        .exception-box {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .exception-box input {
            flex: 1;
            padding: 6px;
            background-color: #4a5568;
            border: 1px solid #718096;
            color: white;
            border-radius: 0.25rem;
        }
        #duplicate-checker-page textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            margin-top: 10px;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #e2e8f0;
            border-radius: 0.5rem;
        }
        #duplicate-checker-page button {
            padding: 8px 16px;
            margin: 5px 5px 5px 0;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        #duplicate-checker-page input[type="number"] {
            width: 80px;
            padding: 5px;
            background-color: #4a5568;
            border: 1px solid #718096;
            color: white;
        }
        #copyStatus {
            margin-left: 10px;
            color: #48bb78; /* green-400 */
            font-weight: bold;
        }
        #stats {
            margin-top: 10px;
            font-weight: bold;
            color: #cbd5e0; /* gray-400 */
        }

        /* --- Styles from Metadata Tool --- */
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        .filter-btn-active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Main Navigation Header -->
    <header class="bg-gray-800 shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#bg-remover" class="text-xl font-bold text-white">Maruf's Toolkit</a>
            <div class="flex items-center space-x-2">
                <a href="#bg-remover" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">BG Remover</a>
                <a href="#renamer" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">File Renamer</a>
                <a href="#duplicate-checker" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Duplicate Checker</a>
                <a href="#metadata-tool" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Metadata Tool</a>
                <a href="#converter" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Image Converter</a>
                <a href="https://marufusion.rf.gd/" target="_blank" class="px-3 py-2 rounded-md text-sm font-medium text-blue-400 hover:bg-gray-700 hover:text-blue-300">Maruf's Portfolio</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <!-- Page 1: Background Remover -->
        <section id="bg-remover-page" class="page-content">
            <div class="w-full max-w-2xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8">
                <div class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Batch Background Remover</h1>
                    <p class="text-gray-400 mt-2">Use your favorite background removal API.</p>
                </div>
                <div class="mb-6">
                    <label for="apiProvider" class="block text-sm font-medium text-gray-300 mb-2">API Provider:</label>
                    <select id="apiProvider" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                        <option value="removebg">remove.bg</option>
                        <option value="clipdrop">ClipDrop</option>
                        <option value="cutoutpro">Cutout.Pro</option>
                        <option value="adobe">Adobe Photoshop API</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="apiKey" class="block text-sm font-medium text-gray-300 mb-2">Your API Key:</label>
                    <input type="text" id="apiKey" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your API key for the selected provider">
                    <div id="apiKeyLinks" class="mt-1">
                         <a id="removebgLink" href="https://www.remove.bg/dashboard#api-key" target="_blank" class="text-xs text-blue-400 hover:underline">Where do I find my remove.bg API Key?</a>
                         <a id="clipdropLink" href="https://clipdrop.co/apis" target="_blank" class="text-xs text-blue-400 hover:underline hidden">Where do I find my ClipDrop API Key?</a>
                         <a id="cutoutproLink" href="https://www.cutout.pro/api-dashboard/api-key" target="_blank" class="text-xs text-blue-400 hover:underline hidden">Where do I find my Cutout.Pro API Key?</a>
                         <a id="adobeLink" href="https://developer.adobe.com/console" target="_blank" class="text-xs text-blue-400 hover:underline hidden">How to get Adobe API credentials</a>
                    </div>
                </div>
                <div class="bg-gray-700 border-2 border-dashed border-gray-500 rounded-lg p-8 text-center mb-6">
                    <div class="relative inline-block">
                        <label id="folder-upload-btn" class="relative w-48 h-12 block">
                            <input type="file" id="folderInput" webkitdirectory directory multiple class="opacity-0 absolute inset-0 w-full h-full cursor-pointer">
                        </label>
                    </div>
                    <p id="upload-prompt" class="mt-4 text-gray-400">1. Select Provider ‚Üí 2. Enter Key ‚Üí 3. Select Folder</p>
                </div>
                <div id="controls" class="hidden">
                    <h2 class="text-xl font-semibold text-white mb-3">Selected Files:</h2>
                    <div id="fileList" class="bg-gray-700 rounded-lg p-4 max-h-60 overflow-y-auto mb-6"></div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="bg-remover-process-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            Remove Backgrounds & Download ZIP
                        </button>
                        <button id="bg-remover-reset-btn" class="w-full sm:w-auto bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Reset</button>
                    </div>
                </div>
                <div id="status" class="hidden text-center mt-6">
                     <p id="statusText" class="text-lg text-blue-400"></p>
                </div>
                 <div id="error-container"></div>
            </div>
        </section>

        <!-- Page 2: File Renamer -->
        <section id="renamer-page" class="page-content">
            <div class="w-full max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 text-slate-800">
                <header class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-slate-900">EPS File Renamer</h1>
                    <p class="text-slate-500 mt-2">Upload EPS files and a CSV with a list of new names to rename them in order.</p>
                </header>
                <div class="space-y-6">
                    <div>
                        <label class="text-lg font-semibold text-slate-700 mb-2 block">Step 1: Upload EPS Files</label>
                        <div id="eps-drop-area" class="file-drop-area border-2 border-dashed border-slate-300 rounded-lg p-6 text-center cursor-pointer bg-slate-50 hover:bg-slate-100">
                            <input type="file" id="eps-files-input" multiple accept=".eps" class="hidden">
                            <div class="flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                                <p class="mt-2 text-slate-600"><span class="font-semibold text-sky-600">Click to select</span> or drag and drop EPS files here.</p>
                                <p class="text-xs text-slate-400 mt-1">The order of files is important.</p>
                                <p id="eps-file-status" class="text-sm text-slate-500 mt-1">No files selected</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-lg font-semibold text-slate-700 mb-2 block">Step 2: Upload New Names List (CSV)</label>
                         <div id="csv-drop-area" class="file-drop-area border-2 border-dashed border-slate-300 rounded-lg p-6 text-center cursor-pointer bg-slate-50 hover:bg-slate-100">
                            <input type="file" id="csv-file-input" accept=".csv, text/csv" class="hidden">
                            <div class="flex flex-col items-center">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                <p class="mt-2 text-slate-600"><span class="font-semibold text-sky-600">Click to select</span> or drag and drop your CSV file here.</p>
                                <p class="text-xs text-slate-400 mt-1">CSV should have a single column of new filenames.</p>
                                <p id="csv-file-status" class="text-sm text-slate-500 mt-1">No file selected</p>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <button id="renamer-process-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-4 focus:ring-sky-300 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center">
                            <svg id="process-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span id="button-text">Rename & Download ZIP</span>
                        </button>
                    </div>
                    <div id="status-message" class="text-center text-sm text-red-600 h-5 mt-4"></div>
                </div>
            </div>
        </section>

        <!-- Page 3: Duplicate Checker -->
        <section id="duplicate-checker-page" class="page-content">
            <div class="w-full max-w-3xl mx-auto bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 text-gray-200">
                <h2 class="text-2xl font-bold mb-4">üé® Highlight Duplicates + Customize Output Format</h2>
                <div id="editableInput" contenteditable="true" placeholder="Paste or type here...">Maruf Maruf Asif Maruf Asif Rakib</div>
                <h3 class="text-xl font-semibold mt-4 mb-2">‚ùó Exception Words (Will Not Be Removed)</h3>
                <div id="exceptionList"></div>
                <button id="add-exception-btn">+ Add Exception</button>
                <br><br>
                <button id="highlight-btn">üîç Highlight Duplicates</button>
                <button id="remove-duplicates-btn">üßº Remove Duplicates</button>
                <div id="stats"></div>
                <h3 class="text-xl font-semibold mt-4 mb-2">üõ† Output Settings</h3>
                Columns: <input type="number" id="columnCount" value="1" min="1" max="50">
                <h3 class="text-xl font-semibold mt-4 mb-2">‚úÖ Cleaned & Formatted Output:</h3>
                <textarea id="output" readonly></textarea>
                <button id="copy-btn">üìã Copy</button>
                <span id="copyStatus"></span>
            </div>
        </section>

        <!-- Page 4: Metadata Tool -->
        <section id="metadata-tool-page" class="page-content">
             <!-- This is a direct copy of the body content from meta data seo and new seperate file csv.html -->
             <div class="container mx-auto p-4 md:p-8 max-w-7xl">
                <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
                    <div class="flex items-center gap-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                        <h1 class="text-2xl md:text-3xl font-bold text-white">All-in-One Metadata Tool</h1>
                    </div>
                    <button id="settings-btn" class="p-2 rounded-md hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                </header>
                <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <aside class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col h-full">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <button id="meta-select-files-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>
                                    Select Files
                                </button>
                                <button id="meta-select-folder-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>
                                    Select Folder
                                </button>
                            </div>
                            <button id="start-generation-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></svg>
                                Start Generation
                            </button>
                            <div id="status-counters" class="p-4 bg-gray-900 rounded-lg text-center space-x-4 hidden">
                                <span id="total-count-wrapper">Total: <span id="total-count">0</span></span>
                                <span id="succeeded-count-wrapper" class="text-green-400 font-medium">Succeeded: <span id="succeeded-count">0</span></span>
                                <span id="failed-count-wrapper" class="text-red-400 font-medium">Failed: <span id="failed-count">0</span></span>
                            </div>
                            <div id="progress-container" class="hidden w-full space-y-2 pt-2">
                                <div class="flex justify-between items-center text-sm font-medium text-gray-400">
                                    <span id="progress-text">Processing...</span>
                                    <span id="progress-percent">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-center gap-4 mt-2">
                                    <button id="pause-btn" class="hidden w-1/2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-all">Pause</button>
                                    <button id="resume-btn" class="hidden w-1/2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-all">Resume</button>
                                </div>
                            </div>
                            <div id="filter-controls" class="grid grid-cols-3 gap-2 hidden">
                                <button data-filter="all" class="filter-btn filter-btn-active py-2 px-4 rounded-md text-sm font-semibold bg-gray-700 hover:bg-gray-600">All</button>
                                <button data-filter="succeeded" class="filter-btn py-2 px-4 rounded-md text-sm font-semibold bg-gray-700 hover:bg-gray-600">Succeeded</button>
                                <button data-filter="failed" class="filter-btn py-2 px-4 rounded-md text-sm font-semibold bg-gray-700 hover:bg-gray-600">Failed</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <button id="download-csv-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                    Download Full CSV
                                </button>
                                <button id="download-zip-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                    Download .zip
                                </button>
                            </div>
                            <div id="filename-csv-controls" class="hidden pt-4 mt-4 border-t border-gray-700 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Original Type:</label>
                                    <div class="grid grid-cols-4 gap-2 text-center text-xs">
                                        <label class="flex items-center gap-1 bg-gray-900 p-2 rounded-md"><input type="checkbox" class="file-type-checkbox h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-500 focus:ring-indigo-400" value=".jpg" checked> JPG</label>
                                        <label class="flex items-center gap-1 bg-gray-900 p-2 rounded-md"><input type="checkbox" class="file-type-checkbox h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-500 focus:ring-indigo-400" value=".png" checked> PNG</label>
                                        <label class="flex items-center gap-1 bg-gray-900 p-2 rounded-md"><input type="checkbox" class="file-type-checkbox h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-500 focus:ring-indigo-400" value=".webp" checked> WEBP</label>
                                        <label class="flex items-center gap-1 bg-gray-900 p-2 rounded-md"><input type="checkbox" class="file-type-checkbox h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-500 focus:ring-indigo-400" value=".svg" checked> SVG</label>
                                    </div>
                                </div>
                                <div>
                                    <label for="custom-extension-input" class="block text-sm font-medium text-gray-300 mb-2">Set Custom Extension (optional):</label>
                                     <input type="text" id="custom-extension-input" class="w-full bg-gray-900 border border-gray-700 text-gray-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="e.g., .svg or .eps">
                                </div>
                                <button id="download-filenames-csv-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line></svg>
                                    Download Filename List
                                </button>
                            </div>
                             <div id="actions-controls" class="hidden pt-4 mt-4 border-t border-gray-700 grid grid-cols-2 gap-4">
                                <button id="download-failed-zip-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                    Download Failed
                                </button>
                                <button id="clear-succeeded-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 btn-disabled">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    Clear Succeeded
                                </button>
                            </div>
                        </div>
                        <div class="flex-grow mt-8 pt-6 border-t border-gray-700 flex flex-col">
                            <h2 class="text-xl font-semibold mb-4 text-white">How it Works</h2>
                            <div class="space-y-4 text-gray-400">
                                 <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">1</div>
                                    <p>Click <strong class="text-gray-300">Settings</strong> (top right) to add your Google AI API key. You can get a free key from <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer" class="text-blue-400 underline">Google AI Studio</a>.</p>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">2</div>
                                    <p>Click <strong class="text-gray-300">Select Files</strong> or <strong class="text-gray-300">Folder</strong> to choose images (including PNG, JPG, WEBP, and SVG).</p>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">3</div>
                                    <p>Click <strong class="text-gray-300">Start Generation</strong> to create titles and keywords.</p>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">4</div>
                                    <p>Use the <strong class="text-gray-300">filters</strong> and <strong class="text-gray-300">action buttons</strong> to manage and download your results.</p>
                                </div>
                            </div>
                            <div class="mt-auto pt-4 text-center text-xs text-gray-500">
                                Created by <a href="https://www.facebook.com/Maaruf32003" target="_blank" rel="noopener noreferrer" class="underline hover:text-blue-400">Maruf</a>
                            </div>
                        </div>
                         <input type="file" id="meta-file-input" class="hidden" multiple accept="image/png, image/jpeg, image/webp, image/svg+xml">
                        <input type="file" id="meta-folder-input" class="hidden" webkitdirectory directory multiple>
                    </aside>
                    <section id="results-panel" class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg min-h-[60vh]">
                        <div id="bulk-actions-bar" class="hidden p-2 bg-gray-700 rounded-lg mb-4 flex items-center gap-4">
                            <input type="checkbox" id="select-all-checkbox" class="h-5 w-5 rounded bg-gray-900 border-gray-600 text-indigo-600 focus:ring-indigo-500">
                            <label for="select-all-checkbox" class="text-sm font-medium">Select All Visible</label>
                            <button id="retry-selected-btn" class="ml-auto bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded-lg text-sm btn-disabled">Retry Selected</button>
                            <button id="delete-selected-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm btn-disabled">Delete Selected</button>
                        </div>
                        <div id="results-container" class="space-y-6">
                            <div id="placeholder" class="text-center text-gray-500 py-20">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                <h3 class="text-lg font-medium text-gray-400">Your images will appear here</h3>
                                <p class="text-sm">Select some images to get started.</p>
                            </div>
                        </div>
                    </section>
                </main>
            </div>
            <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden transition-all">
                <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md transform transition-all scale-95 opacity-0" id="settings-modal-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">Settings</h2>
                        <button id="close-settings-btn" class="p-2 rounded-full hover:bg-gray-700 text-gray-400">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">Google AI API Key</label>
                            <input type="password" id="api-key-input" class="w-full bg-gray-900 border border-gray-700 text-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Enter your API key">
                            <p class="text-xs text-gray-500 mt-2">Your key is stored only in your browser's local storage and is never shared.</p>
                        </div>
                        <button id="save-api-key-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all">Save Key</button>
                    </div>
                </div>
            </div>
            <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden transition-all">
                <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md transform transition-all scale-95 opacity-0" id="confirm-modal-content">
                    <h2 id="confirm-title" class="text-2xl font-bold text-white mb-4">Are you sure?</h2>
                    <p id="confirm-message" class="text-gray-400 mb-6">This action cannot be undone.</p>
                    <div class="flex justify-end gap-4">
                        <button id="confirm-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-semibold">Cancel</button>
                        <button id="confirm-action-btn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">Confirm</button>
                    </div>
                </div>
            </div>
            <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl translate-x-[120%] transition-transform duration-500">
                <p id="toast-message"></p>
            </div>
        </section>

        <!-- Page 5: Image Converter -->
        <section id="converter-page" class="page-content">
            <div class="w-full max-w-2xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8">
                <div class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Batch Image Converter</h1>
                    <p class="text-gray-400 mt-2">Convert SVG, PNG, and WEBP files to JPG or PNG.</p>
                </div>
                <div class="mb-6">
                    <label for="outputFormat" class="block text-sm font-medium text-gray-300 mb-2">Output Format:</label>
                    <select id="outputFormat" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                        <option value="image/jpeg">JPG</option>
                        <option value="image/png">PNG</option>
                    </select>
                </div>
                <div class="bg-gray-700 border-2 border-dashed border-gray-500 rounded-lg p-8 text-center mb-6">
                    <div class="relative inline-block">
                        <label id="converter-folder-upload-btn" class="relative w-48 h-12 block">
                            <input type="file" id="converterFolderInput" webkitdirectory directory multiple class="opacity-0 absolute inset-0 w-full h-full cursor-pointer">
                        </label>
                    </div>
                    <p id="converter-upload-prompt" class="mt-4 text-gray-400">Select a folder of images to convert.</p>
                </div>
                <div id="converter-controls" class="hidden">
                    <h2 class="text-xl font-semibold text-white mb-3">Selected Files:</h2>
                    <div id="converterFileList" class="bg-gray-700 rounded-lg p-4 max-h-60 overflow-y-auto mb-6"></div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="converter-process-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12A8 8 0 1013 5.26"></path></svg>
                            Convert & Download ZIP
                        </button>
                        <button id="converter-reset-btn" class="w-full sm:w-auto bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Reset</button>
                    </div>
                </div>
                <div id="converter-status" class="hidden text-center mt-6">
                     <p id="converterStatusText" class="text-lg text-blue-400"></p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-400 py-4 border-t border-gray-700">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <p class="text-sm">
                Created by <a href="https://www.facebook.com/Maaruf32003" target="_blank" rel="noopener noreferrer" class="font-semibold text-blue-400 hover:underline">Maruf</a>
            </p>
            <div class="flex items-center gap-4">
                 <button id="bkash-support-btn" class="flex items-center gap-2 bg-pink-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-pink-700 transition-colors text-sm">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.3,5.42a.3.3,0,0,0-.42.31l.6,6.26a.3.3,0,0,0,.3.28.31.31,0,0,0,.28-.3l-.6-6.26A.3.3,0,0,0,16.3,5.42Zm-8.4,0a.3.3,0,0,0-.11.59l5.4,3.12a.3.3,0,0,0,.42-.31.3.3,0,0,0-.31-.27l-5.4-3.12A.3.3,0,0,0,7.9,5.42Zm.2,3.87a.3.3,0,0,0-.42.3l.9,5.62a.3.3,0,0,0,.59-.1l-.9-5.62A.3.3,0,0,0,8.1,9.29Zm7.4-2.29a.3.3,0,0,0-.42.31l-3,5.19a.3.3,0,0,0,.52.37l3-5.19A.3.3,0,0,0,15.5,7ZM12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm3.6,13.2a1.5,1.5,0,0,1-2.11.39l-1.38-.8a.3.3,0,0,0-.3,0l-1.38.8a1.5,1.5,0,0,1-1.73-.2,1.5,1.5,0,0,1-.38-1.82l.9-5.62A1.5,1.5,0,0,1,10.3,6.5a1.52,1.52,0,0,1,.87.27l5.4,3.12a1.5,1.5,0,0,1-.58,2.72l-3,5.19a1.5,1.5,0,0,1-2.49.13L12,17.42l-1.76.63a1.5,1.5,0,0,1-1.83-1.5l.6-6.26a1.5,1.5,0,0,1,3,0l-.6,6.26a.3.3,0,0,0,.36.3l1.76-.63a.3.3,0,0,0,.15-.26l3-5.19A1.5,1.5,0,0,1,18.1,8.1L12.7,5a1.5,1.5,0,0,1-.68-2,1.5,1.5,0,0,1,2.11-.39l5.4,3.12A1.5,1.5,0,0,1,15.6,15.2Z" fill="currentColor"></path></svg>
                    <span>Support</span>
                </button>
                <a href="https://wa.me/8801815753403" target="_blank" rel="noopener noreferrer" class="hover:text-green-400 transition-colors" title="Contact on WhatsApp">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.2,4.8A10.1,10.1,0,0,0,12,2,10,10,0,0,0,2,12a10,10,0,0,0,7.1,9.7L7.6,23.3l1.8-1.5a8.1,8.1,0,0,0,2.6.4h0A10,10,0,0,0,12,21.9a10.1,10.1,0,0,0,7.2-17.1ZM12,20.1h0a8.3,8.3,0,0,1-4.3-1.2l-.3-.2-3.2.8.9-3.1-.2-.3a8.3,8.3,0,1,1,7.1,5Zm4.8-6.1c-.3-.1-1.6-.8-1.9-.9s-.5-.1-.7.1-.7.9-.9,1.1-.4.2-.7,0a7.6,7.6,0,0,1-2.2-1.4,8.4,8.4,0,0,1-1.5-2c-.2-.3,0-.5.1-.6s.3-.3.4-.5a1.8,1.8,0,0,0,.2-.4.4.4,0,0,0,0-.7c-.1-.1-.7-1.6-.9-2.2s-.4-.5-.7-.5h-.7a1.2,1.2,0,0,0-.9.4,3.8,3.8,0,0,0-1.2,2.8,4.9,4.9,0,0,0,1,3.3,9.5,9.5,0,0,0,2.4,3.2,12.5,12.5,0,0,0,4.2,2.6c.5.2,1,.3,1.3.4s.7.1,1,.1.7-.1,1-.3.7-.7.9-.9.2-.4.1-.7S17,14,16.8,14Z"/></svg>
                </a>
                <a href="https://www.facebook.com/Maaruf32003" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors" title="Find on Facebook">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M13.397,20.997v-8.196h2.765l.411-3.209h-3.176V7.548c0-.926.258-1.56,1.587-1.56h1.684V3.127A22.336,22.336,0,0,0,14.201,3c-2.444,0-4.122,1.492-4.122,4.231v2.355H7.332v3.209h2.753v8.196h3.312Z"/></svg>
                </a>
            </div>
        </div>
    </footer>

    <!-- Toast for bKash copy confirmation -->
    <div id="copy-toast" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-5 rounded-lg shadow-xl translate-x-[120%] transition-transform duration-500">
        <p>bKash number copied to clipboard!</p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Main Navigation Logic ---
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page-content');

        function showPage(hash) {
            const targetId = hash.substring(1) + '-page';
            
            pages.forEach(page => {
                page.classList.remove('active');
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
            });

            const targetPage = document.getElementById(targetId);
            const targetLink = document.querySelector(`.nav-link[href="${hash}"]`);

            if (targetPage) {
                targetPage.classList.add('active');
            }
            if(targetLink) {
                targetLink.classList.add('active');
            }
        }

        // Handle navigation clicks
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const hash = e.target.hash;
                window.location.hash = hash;
            });
        });
        
        // Handle hash changes (for back/forward buttons and direct links)
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash || '#bg-remover';
            showPage(hash);
        });

        // Show initial page based on hash or default
        const initialHash = window.location.hash || '#bg-remover';
        showPage(initialHash);


        // --- BG Remover Tool Logic ---
        (function() {
            const apiConfigs = {
                removebg: { url: 'https://api.remove.bg/v1.0/removebg', keyHeader: 'X-Api-Key', imageFieldName: 'image_file' },
                clipdrop: { url: 'https://api.clipdrop.co/remove-background/v1', keyHeader: 'x-api-key', imageFieldName: 'image_file' },
                cutoutpro: { url: 'https://api.cutout.pro/v1/removeBackground', keyHeader: 'X-API-KEY', imageFieldName: 'file' },
                adobe: { url: 'https://image.adobe.io/v1/cutout', keyHeader: 'x-api-key', authHeader: 'Authorization', imageFieldName: 'image' }
            };
            const page = document.getElementById('bg-remover-page');
            if (!page) return;

            const apiProviderSelect = page.querySelector('#apiProvider');
            const apiKeyInput = page.querySelector('#apiKey');
            const folderInput = page.querySelector('#folderInput');
            const fileListDiv = page.querySelector('#fileList');
            const controlsDiv = page.querySelector('#controls');
            const processBtn = page.querySelector('#bg-remover-process-btn');
            const resetBtn = page.querySelector('#bg-remover-reset-btn');
            const statusDiv = page.querySelector('#status');
            const statusText = page.querySelector('#statusText');
            const uploadPrompt = page.querySelector('#upload-prompt');
            const errorContainer = page.querySelector('#error-container');
            const removebgLink = page.querySelector('#removebgLink');
            const clipdropLink = page.querySelector('#clipdropLink');
            const cutoutproLink = page.querySelector('#cutoutproLink');
            const adobeLink = page.querySelector('#adobeLink');

            let selectedFiles = [];

            apiProviderSelect.addEventListener('change', updateApiKeyLink);
            folderInput.addEventListener('change', handleFolderSelection);
            processBtn.addEventListener('click', processImages);
            resetBtn.addEventListener('click', resetState);

            function updateApiKeyLink() {
                const provider = apiProviderSelect.value;
                removebgLink.classList.toggle('hidden', provider !== 'removebg');
                clipdropLink.classList.toggle('hidden', provider !== 'clipdrop');
                cutoutproLink.classList.toggle('hidden', provider !== 'cutoutpro');
                adobeLink.classList.toggle('hidden', provider !== 'adobe');
            }

            function handleFolderSelection(event) {
                if (!apiKeyInput.value.trim()) {
                    showError("Please enter your API key before selecting a folder.");
                    folderInput.value = '';
                    return;
                }
                errorContainer.innerHTML = '';
                selectedFiles = Array.from(event.target.files).filter(file => /\.(jpe?g|png|gif|webp)$/i.test(file.name));
                if (selectedFiles.length > 0) {
                    displayFiles();
                    controlsDiv.classList.remove('hidden');
                    uploadPrompt.textContent = `${selectedFiles.length} image(s) selected.`;
                } else {
                    resetState();
                    uploadPrompt.textContent = 'No valid image files found in the selected folder.';
                }
            }

            function displayFiles() {
                fileListDiv.innerHTML = '';
                selectedFiles.forEach(file => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'bg-gray-900 p-2 rounded mb-2 text-sm text-gray-300';
                    fileElement.textContent = file.name;
                    fileListDiv.appendChild(fileElement);
                });
            }

            function showError(message) {
                errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            }

            async function processImages() {
                const provider = apiProviderSelect.value;
                const config = apiConfigs[provider];
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) { showError('Please enter your API key.'); return; }
                if (selectedFiles.length === 0) { showError('Please select a folder with images first.'); return; }
                setLoadingState(true);
                const zip = new JSZip();
                let successCount = 0;
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    statusText.textContent = `Processing image ${i + 1} of ${selectedFiles.length}: ${file.name}`;
                    const formData = new FormData();
                    formData.append(config.imageFieldName, file);
                    const headers = { [config.keyHeader]: apiKey };
                    if (provider === 'adobe') {
                        showError("Note: Adobe API integration is for demonstration. A real implementation requires a server-side OAuth2 flow to get an access token.");
                    }
                    try {
                        const response = await fetch(config.url, { method: 'POST', headers: headers, body: formData });
                        if (response.ok) {
                            const blob = await response.blob();
                            zip.file(file.name.replace(/\.[^/.]+$/, "") + '.png', blob);
                            successCount++;
                        } else {
                            const errorText = await response.text();
                            showError(`Failed to process ${file.name}: ${errorText}`);
                        }
                    } catch (error) {
                        showError(`Network error while processing ${file.name}. Please check your connection.`);
                    }
                }
                if (successCount > 0) {
                    statusText.textContent = 'Zipping processed files...';
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    downloadZip(zipBlob);
                    statusText.textContent = `Successfully processed and downloaded ${successCount} images!`;
                } else {
                     statusText.textContent = 'No images were processed successfully.';
                }
                setLoadingState(false);
            }

            function setLoadingState(isLoading) {
                statusDiv.classList.toggle('hidden', !isLoading);
                processBtn.disabled = isLoading;
                processBtn.classList.toggle('opacity-50', isLoading);
                processBtn.classList.toggle('cursor-not-allowed', isLoading);
            }

            function downloadZip(blob) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'processed_images.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function resetState() {
                selectedFiles = [];
                folderInput.value = '';
                fileListDiv.innerHTML = '';
                controlsDiv.classList.add('hidden');
                statusDiv.classList.add('hidden');
                statusText.textContent = '';
                errorContainer.innerHTML = '';
                uploadPrompt.textContent = '1. Select Provider ‚Üí 2. Enter Key ‚Üí 3. Select Folder';
                updateApiKeyLink();
            }
            updateApiKeyLink();
        })();


        // --- File Renamer Tool Logic ---
        (function() {
            const page = document.getElementById('renamer-page');
            if (!page) return;

            const epsDropArea = page.querySelector('#eps-drop-area');
            const epsFilesInput = page.querySelector('#eps-files-input');
            const epsFileStatus = page.querySelector('#eps-file-status');
            const csvDropArea = page.querySelector('#csv-drop-area');
            const csvFileInput = page.querySelector('#csv-file-input');
            const csvFileStatus = page.querySelector('#csv-file-status');
            const processBtn = page.querySelector('#renamer-process-btn');
            const statusMessage = page.querySelector('#status-message');
            const buttonText = page.querySelector('#button-text');
            const processIcon = page.querySelector('#process-icon');
            const loadingSpinner = page.querySelector('#loading-spinner');

            function setupDragDrop(dropArea, fileInput) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false));
                ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false));
                ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false));
                dropArea.addEventListener('drop', (e) => {
                    fileInput.files = e.dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change'));
                }, false);
                dropArea.addEventListener('click', () => fileInput.click());
            }
            setupDragDrop(epsDropArea, epsFilesInput);
            setupDragDrop(csvDropArea, csvFileInput);

            epsFilesInput.addEventListener('change', () => {
                if (epsFilesInput.files.length > 0) {
                    epsFileStatus.textContent = `${epsFilesInput.files.length} file(s) selected.`;
                    epsFileStatus.classList.add('text-green-600');
                } else {
                    epsFileStatus.textContent = 'No files selected';
                    epsFileStatus.classList.remove('text-green-600');
                }
            });

            csvFileInput.addEventListener('change', () => {
                if (csvFileInput.files.length > 0) {
                    csvFileStatus.textContent = `Selected: ${csvFileInput.files[0].name}`;
                    csvFileStatus.classList.add('text-green-600');
                } else {
                    csvFileStatus.textContent = 'No file selected';
                    csvFileStatus.classList.remove('text-green-600');
                }
            });

            processBtn.addEventListener('click', async function handleFileProcessing() {
                const epsFilesList = epsFilesInput.files;
                const csvFile = csvFileInput.files[0];
                if (epsFilesList.length === 0) { showError("Please upload at least one EPS file."); return; }
                if (!csvFile) { showError("Please upload a CSV file with new names."); return; }
                
                // *** FIX: Sort the uploaded files alphabetically ***
                const epsFiles = Array.from(epsFilesList).sort((a, b) => a.name.localeCompare(b.name));

                setLoadingState(true);
                try {
                    const newNames = await parseCsvToArray(csvFile);
                    if (newNames.length === 0) { showError("CSV file is empty or could not be parsed correctly."); setLoadingState(false); return; }
                    if (epsFiles.length !== newNames.length) { showError(`Mismatch: ${epsFiles.length} files uploaded, but ${newNames.length} names found in CSV.`); setLoadingState(false); return; }
                    const zip = new JSZip();
                    for (let i = 0; i < epsFiles.length; i++) {
                        const file = epsFiles[i];
                        const newName = newNames[i];
                        if (newName) { zip.file(newName, file); }
                    }
                    const filesZipped = Object.keys(zip.files).length;
                    if (filesZipped === 0) { showError("No files were added to the zip. Check your CSV."); setLoadingState(false); return; }
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = 'renamed_eps_files.zip';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showSuccess(`Success! ${filesZipped} files were renamed and zipped.`);
                } catch (error) {
                    console.error("An error occurred:", error);
                    showError("An unexpected error occurred. Check the console.");
                } finally {
                    setLoadingState(false);
                }
            });

            function parseCsvToArray(file) {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: false, skipEmptyLines: true,
                        complete: (results) => {
                            const nameArray = results.data.map(row => row[0] && row[0].trim()).filter(Boolean);
                            resolve(nameArray);
                        },
                        error: (error) => reject(error)
                    });
                });
            }

            function setLoadingState(isLoading) {
                processBtn.disabled = isLoading;
                buttonText.textContent = isLoading ? "Processing..." : "Rename & Download ZIP";
                processIcon.classList.toggle('hidden', isLoading);
                loadingSpinner.classList.toggle('hidden', !isLoading);
            }

            function showError(message) {
                statusMessage.textContent = message;
                statusMessage.className = 'text-center text-sm text-red-600 h-5 mt-4';
            }
            function showSuccess(message) {
                statusMessage.textContent = message;
                statusMessage.className = 'text-center text-sm text-green-600 h-5 mt-4';
            }
        })();

        // --- Duplicate Checker Tool Logic ---
        (function() {
            const page = document.getElementById('duplicate-checker-page');
            if (!page) return;

            const addExceptionBtn = page.querySelector('#add-exception-btn');
            const highlightBtn = page.querySelector('#highlight-btn');

            const removeDuplicatesBtn = page.querySelector('#remove-duplicates-btn');
            const copyBtn = page.querySelector('#copy-btn');
            const exceptionList = page.querySelector('#exceptionList');

            function addExceptionBox(value = '') {
                const div = document.createElement("div");
                div.className = "exception-box";
                div.innerHTML = `<input type="text" value="${value}" placeholder="e.g. Maruf"><button onclick="this.parentElement.remove()">‚ùå</button>`;
                exceptionList.appendChild(div);
            }

            function getExceptions() {
                return Array.from(page.querySelectorAll("#exceptionList input")).map(e => e.value.trim()).filter(Boolean);
            }

            function generateColor(index) {
                const colors = ["#ffd1dc", "#d1e7ff", "#d1ffd6", "#fffac8", "#ffdfba", "#e6ccff", "#ffb3ba", "#bae1ff", "#baffc9", "#ffffba", "#ffb347", "#e3f2fd"];
                return colors[index % colors.length];
            }

            highlightBtn.addEventListener('click', function highlightAndCount() {
                const rawText = page.querySelector("#editableInput").innerText;
                const exceptions = getExceptions();
                const words = rawText.match(/\S+/g) || [];
                const map = {}, final = [];
                words.forEach(word => { const w = word.trim(); map[w] = (map[w] || 0) + 1; });
                const duplicateWords = Object.keys(map).filter(w => map[w] > 1 && !exceptions.includes(w));
                const colorMap = {};
                duplicateWords.forEach((word, i) => { colorMap[word] = generateColor(i); });
                let duplicateCount = 0;
                words.forEach(word => {
                    if (map[word] > 1 && !exceptions.includes(word)) {
                        final.push(`<span style="background-color:${colorMap[word]}; font-weight:bold;">${word}</span>`);
                        duplicateCount++;
                    } else {
                        final.push(word);
                    }
                });
                page.querySelector("#editableInput").innerHTML = final.join(' ').replace(/\n/g, '<br>');
                page.querySelector("#stats").innerText = `üî¢ Total Words: ${words.length} | üß© Unique: ${Object.keys(map).length} | ‚ö†Ô∏è Duplicates: ${duplicateCount}`;
            });

            removeDuplicatesBtn.addEventListener('click', function removeDuplicates() {
                const rawText = page.querySelector("#editableInput").innerText;
                const exceptions = getExceptions();
                const columnCount = parseInt(page.querySelector("#columnCount").value) || 1;
                const words = rawText.match(/\S+/g) || [];
                const seen = new Set();
                const result = [];
                for (let word of words) {
                    if (!seen.has(word) || exceptions.includes(word)) {
                        result.push(word);
                        seen.add(word);
                    }
                }
                let formatted = '';
                for (let i = 0; i < result.length; i++) {
                    formatted += result[i] + '\t';
                    if ((i + 1) % columnCount === 0) formatted += '\n';
                }
                page.querySelector("#output").value = formatted.trim();
            });

            copyBtn.addEventListener('click', function copyOutput() {
                const text = page.querySelector("#output").value;
                navigator.clipboard.writeText(text).then(() => {
                    const status = page.querySelector("#copyStatus");
                    status.textContent = "Copied!";
                    setTimeout(() => status.textContent = "", 2000);
                });
            });

            addExceptionBtn.addEventListener('click', () => addExceptionBox());
            addExceptionBox(); // Add one by default
        })();


        // --- Metadata Tool Logic ---
        (function() {
            const page = document.getElementById('metadata-tool-page');
            if (!page) return;
            const settingsBtn = page.querySelector('#settings-btn');
            const closeSettingsBtn = page.querySelector('#close-settings-btn');
            const settingsModal = page.querySelector('#settings-modal');
            const settingsModalContent = page.querySelector('#settings-modal-content');
            const apiKeyInput = page.querySelector('#api-key-input');
            const saveApiKeyBtn = page.querySelector('#save-api-key-btn');
            const selectFilesBtn = page.querySelector('#meta-select-files-btn');
            const selectFolderBtn = page.querySelector('#meta-select-folder-btn');
            const fileInput = page.querySelector('#meta-file-input');
            const folderInput = page.querySelector('#meta-folder-input');
            const startGenerationBtn = page.querySelector('#start-generation-btn');
            const downloadCsvBtn = page.querySelector('#download-csv-btn');
            const downloadZipBtn = page.querySelector('#download-zip-btn');
            const downloadFailedZipBtn = page.querySelector('#download-failed-zip-btn');
            const clearSucceededBtn = page.querySelector('#clear-succeeded-btn');
            const resultsContainer = page.querySelector('#results-container');
            const placeholder = page.querySelector('#placeholder');
            const toast = page.querySelector('#toast');
            const toastMessage = page.querySelector('#toast-message');
            const progressContainer = page.querySelector('#progress-container');
            const progressBar = page.querySelector('#progress-bar');
            const progressText = page.querySelector('#progress-text');
            const progressPercent = page.querySelector('#progress-percent');
            const statusCounters = page.querySelector('#status-counters');
            const totalCountEl = page.querySelector('#total-count');
            const succeededCountEl = page.querySelector('#succeeded-count');
            const failedCountEl = page.querySelector('#failed-count');
            const totalCountWrapper = page.querySelector('#total-count-wrapper');
            const succeededCountWrapper = page.querySelector('#succeeded-count-wrapper');
            const failedCountWrapper = page.querySelector('#failed-count-wrapper');
            const filterControls = page.querySelector('#filter-controls');
            const actionsControls = page.querySelector('#actions-controls');
            const confirmModal = page.querySelector('#confirm-modal');
            const confirmModalContent = page.querySelector('#confirm-modal-content');
            const confirmCancelBtn = page.querySelector('#confirm-cancel-btn');
            const confirmActionBtn = page.querySelector('#confirm-action-btn');
            const pauseBtn = page.querySelector('#pause-btn');
            const resumeBtn = page.querySelector('#resume-btn');
            const bulkActionsBar = page.querySelector('#bulk-actions-bar');
            const selectAllCheckbox = page.querySelector('#select-all-checkbox');
            const retrySelectedBtn = page.querySelector('#retry-selected-btn');
            const deleteSelectedBtn = page.querySelector('#delete-selected-btn');
            const filenameCsvControls = page.querySelector('#filename-csv-controls');
            const downloadFilenamesCsvBtn = page.querySelector('#download-filenames-csv-btn');
            const customExtensionInput = page.querySelector('#custom-extension-input');

            const CONCURRENCY_LIMIT = 15; 
            let apiKey = '';
            let imageFiles = []; 
            let results = {}; 
            let currentFilter = 'all';
            let confirmActionCallback = null;
            let isPaused = false;
            let isProcessing = false;
            
            const ADOBE_CATEGORIES = { 1: "Animals", 2: "Buildings and Architecture", 3: "Business", 4: "Drinks", 5: "The Environment", 6: "States of Mind", 7: "Food", 8: "Graphic Resources", 9: "Hobbies and Leisure", 10: "Industry", 11: "Landscapes", 12: "Lifestyle", 13: "People", 14: "Plants and Flowers", 15: "Culture and Religion", 16: "Science", 17: "Social Issues", 18: "Sports", 19: "Technology", 20: "Transport", 21: "Travel" };
            const categoryListForPrompt = Object.entries(ADOBE_CATEGORIES).map(([id, name]) => `${id} - ${name}`).join('\n');

            const init = () => {
                const savedKey = localStorage.getItem('googleAiApiKey');
                if (savedKey) { apiKey = savedKey; apiKeyInput.value = savedKey; }
                updateButtonStates();
                attachEventListeners();
            };

            const attachEventListeners = () => {
                settingsBtn.addEventListener('click', openSettingsModal);
                closeSettingsBtn.addEventListener('click', closeSettingsModal);
                settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });
                saveApiKeyBtn.addEventListener('click', saveApiKey);
                selectFilesBtn.addEventListener('click', () => fileInput.click());
                selectFolderBtn.addEventListener('click', () => folderInput.click());
                fileInput.addEventListener('change', (e) => processFileObjects(e.target.files));
                folderInput.addEventListener('change', (e) => processFileObjects(e.target.files));
                startGenerationBtn.addEventListener('click', () => handleGeneration(getPendingImages()));
                downloadCsvBtn.addEventListener('click', handleCsvDownload);
                downloadZipBtn.addEventListener('click', handleZipDownload);
                downloadFailedZipBtn.addEventListener('click', handleFailedZipDownload);
                clearSucceededBtn.addEventListener('click', () => { openConfirmModal('Are you sure you want to clear all succeeded images?', () => { handleClearSucceeded(); closeConfirmModal(); }); });
                downloadFilenamesCsvBtn.addEventListener('click', handleFilenamesCsvDownload);
                filterControls.addEventListener('click', (e) => {
                    if (e.target.matches('.filter-btn')) {
                        currentFilter = e.target.dataset.filter;
                        selectAllCheckbox.checked = false;
                        renderResults();
                    }
                });
                confirmCancelBtn.addEventListener('click', closeConfirmModal);
                confirmActionBtn.addEventListener('click', () => { if (typeof confirmActionCallback === 'function') { confirmActionCallback(); } });
                pauseBtn.addEventListener('click', () => { isPaused = true; pauseBtn.classList.add('hidden'); resumeBtn.classList.remove('hidden'); progressText.textContent = 'Paused'; });
                resumeBtn.addEventListener('click', () => { isPaused = false; resumeBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden'); progressText.textContent = 'Resuming...'; });
                selectAllCheckbox.addEventListener('change', handleSelectAll);
                retrySelectedBtn.addEventListener('click', handleRetrySelected);
                deleteSelectedBtn.addEventListener('click', handleDeleteSelected);
            };

            const updateButtonStates = () => {
                const hasApiKey = !!apiKey;
                const hasFiles = imageFiles.length > 0;
                const hasSucceeded = Object.values(results).some(r => r.status === 'Complete');
                const hasFailed = Object.values(results).some(r => r.status === 'Error');
                startGenerationBtn.classList.toggle('btn-disabled', !(hasApiKey && hasFiles && !isProcessing));
                downloadCsvBtn.classList.toggle('btn-disabled', !(hasFiles && hasSucceeded && !isProcessing));
                downloadZipBtn.classList.toggle('btn-disabled', !(hasFiles && hasSucceeded && !isProcessing));
                clearSucceededBtn.classList.toggle('btn-disabled', !(hasFiles && hasSucceeded && !isProcessing));
                downloadFilenamesCsvBtn.classList.toggle('btn-disabled', !(hasFiles && hasSucceeded && !isProcessing));
                downloadFailedZipBtn.classList.toggle('btn-disabled', !(hasFiles && hasFailed && !isProcessing));
            };

            const updateCounters = () => {
                const total = imageFiles.length;
                const succeeded = Object.values(results).filter(r => r.status === 'Complete').length;
                const failed = Object.values(results).filter(r => r.status === 'Error').length;
                totalCountEl.textContent = total;
                succeededCountEl.textContent = succeeded;
                failedCountEl.textContent = failed;
                totalCountWrapper.classList.toggle('hidden', currentFilter !== 'all');
                succeededCountWrapper.classList.toggle('hidden', currentFilter === 'failed');
                failedCountWrapper.classList.toggle('hidden', currentFilter === 'succeeded');
            };

            const renderResults = () => {
                updateCounters();
                let filteredImages = imageFiles;
                if (currentFilter === 'succeeded') filteredImages = imageFiles.filter(img => results[img.id]?.status === 'Complete');
                else if (currentFilter === 'failed') filteredImages = imageFiles.filter(img => results[img.id]?.status === 'Error');
                bulkActionsBar.classList.toggle('hidden', imageFiles.length === 0);
                if (filteredImages.length === 0 && imageFiles.length > 0) {
                    resultsContainer.innerHTML = `<div class="text-center text-gray-500 py-20"><h3 class="text-lg font-medium text-gray-400">No images match the filter "${currentFilter}"</h3></div>`;
                    return;
                }
                if (imageFiles.length === 0) { placeholder.classList.remove('hidden'); resultsContainer.innerHTML = ''; resultsContainer.appendChild(placeholder); return; }
                placeholder.classList.add('hidden');
                resultsContainer.innerHTML = '';
                filteredImages.forEach(img => {
                    const resultData = results[img.id] || { title: '', keywords: '', filename: '', category: '', status: 'Pending', errorMessage: '' };
                    const card = document.createElement('div');
                    card.id = `card-${img.id}`;
                    card.className = 'bg-gray-900 p-4 rounded-lg shadow-md flex items-center gap-4 transition-all';
                    let statusColor = 'text-yellow-400';
                    if (resultData.status === 'Complete') statusColor = 'text-green-400';
                    if (resultData.status === 'Error') statusColor = 'text-red-400';
                    if (resultData.status === 'Generating...' || resultData.status === 'Converting SVG...') statusColor = 'text-blue-400 animate-pulse';
                    let actionAreaHtml = (resultData.status === 'Error') ? `<div class="mt-2 flex items-center gap-4"><button onclick="metadataTool.retryIndividualImage('${img.id}')" class="text-sm bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded-lg transition-all">Try Again</button>${resultData.errorMessage ? `<div class="text-xs text-red-400"><strong>Error:</strong> ${resultData.errorMessage}</div>` : ''}</div>` : '';
                    card.innerHTML = `<div class="flex-shrink-0"><input type="checkbox" data-id="${img.id}" class="image-checkbox h-5 w-5 rounded bg-gray-900 border-gray-600 text-indigo-600 focus:ring-indigo-500" ${img.selected ? 'checked' : ''}></div><div class="flex-shrink-0 w-full md:w-48 h-32"><img src="${img.objectUrl}" alt="${img.file.name}" class="w-full h-full object-cover rounded-md"></div><div class="flex-grow space-y-2 w-full"><div class="flex justify-between items-start"><p class="font-semibold text-gray-300 break-all">${img.file.name}</p><span id="status-${img.id}" class="text-sm font-medium ${statusColor}">${resultData.status}</span></div><div><label for="title-${img.id}" class="text-xs font-medium text-gray-400">Title</label><textarea id="title-${img.id}" rows="2" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" oninput="metadataTool.updateResult('${img.id}', 'title', this.value)">${resultData.title}</textarea></div><div class="grid grid-cols-2 gap-4"><div><label for="filename-${img.id}" class="text-xs font-medium text-gray-400">New Filename (for .zip)</label><input type="text" id="filename-${img.id}" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" value="${resultData.filename}" oninput="metadataTool.updateResult('${img.id}', 'filename', this.value)"></div><div><label for="category-${img.id}" class="text-xs font-medium text-gray-400">Category</label><input type="text" id="category-${img.id}" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" value="${resultData.category}" oninput="metadataTool.updateResult('${img.id}', 'category', this.value)"></div></div><div><label for="keywords-${img.id}" class="text-xs font-medium text-gray-400">Keywords</label><textarea id="keywords-${img.id}" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded-md p-2 text-sm focus:ring-1 focus:ring-blue-500" oninput="metadataTool.updateResult('${img.id}', 'keywords', this.value)">${resultData.keywords}</textarea></div>${actionAreaHtml}</div>`;
                    resultsContainer.appendChild(card);
                });
                page.querySelectorAll('.image-checkbox').forEach(cb => cb.addEventListener('change', handleSelectionChange));
                updateBulkActionState();
            };

            window.metadataTool = {
                updateResult: (id, field, value) => { if (results[id]) results[id][field] = value; },
                retryIndividualImage: async (id) => {
                    if (isProcessing) { showToast("Please wait for the current batch to finish before retrying.", "info"); return; }
                    const imageToRetry = imageFiles.find(img => img.id === id);
                    if (imageToRetry) await handleGeneration([imageToRetry]);
                }
            };

            const showToast = (message, type = 'success') => {
                toastMessage.textContent = message;
                toast.className = 'fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl transition-transform duration-500';
                if (type === 'success') toast.classList.add('bg-green-600');
                else if (type === 'error') toast.classList.add('bg-red-600');
                else toast.classList.add('bg-blue-600');
                toast.classList.remove('translate-x-[120%]');
                setTimeout(() => toast.classList.add('translate-x-[120%]'), 3000);
            };

            const openSettingsModal = () => { settingsModal.classList.remove('hidden'); setTimeout(() => settingsModalContent.classList.remove('scale-95', 'opacity-0'), 10); };
            const closeSettingsModal = () => { settingsModalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => settingsModal.classList.add('hidden'), 300); };
            const openConfirmModal = (message, callback) => { page.querySelector('#confirm-message').textContent = message; confirmActionCallback = callback; confirmModal.classList.remove('hidden'); setTimeout(() => confirmModalContent.classList.remove('scale-95', 'opacity-0'), 10); };
            const closeConfirmModal = () => { confirmModalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => { confirmModal.classList.add('hidden'); confirmActionCallback = null; }, 300); };
            const saveApiKey = () => { const key = apiKeyInput.value.trim(); if (key) { apiKey = key; localStorage.setItem('googleAiApiKey', key); showToast('API Key saved successfully!'); closeSettingsModal(); updateButtonStates(); } else { showToast('Please enter a valid API key.', 'error'); } };

            const processFileObjects = (fileList) => {
                imageFiles.forEach(img => URL.revokeObjectURL(img.objectUrl));
                const files = Array.from(fileList);
                // *** FIX: Sort the uploaded files alphabetically ***
                files.sort((a, b) => a.name.localeCompare(b.name));
                const imageExtensions = ['.png', '.jpg', '.jpeg', '.webp', '.svg'];
                const sanitizeForId = (str) => str.replace(/[^a-zA-Z0-9_-]/g, '-');
                const imageFileObjects = files.filter(file => imageExtensions.some(ext => file.name.toLowerCase().endsWith(ext)));
                if (imageFileObjects.length === 0) { showToast('No compatible image files found.', 'info'); return; }
                imageFiles = imageFileObjects.map(file => ({ file, id: `${sanitizeForId(file.name)}-${file.lastModified}-${file.size}`, objectUrl: URL.createObjectURL(file), selected: false }));
                results = {};
                currentFilter = 'all';
                page.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
                page.querySelector('.filter-btn[data-filter="all"]').classList.add('filter-btn-active');
                filterControls.classList.add('hidden');
                statusCounters.classList.add('hidden');
                actionsControls.classList.add('hidden');
                filenameCsvControls.classList.add('hidden');
                renderResults();
                updateButtonStates();
                showToast(`${imageFiles.length} image(s) ready.`);
                fileInput.value = '';
                folderInput.value = '';
            };

            const readFileAsBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(file); });
            const convertSvgToPngBlob = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0); canvas.toBlob((blob) => { if (blob) resolve(new File([blob], file.name.replace(/\.svg$/, '.png'), { type: 'image/png' })); else reject(new Error('Canvas to Blob conversion failed')); }, 'image/png'); }; img.onerror = () => reject(new Error('Failed to load SVG into image element.')); img.src = e.target.result; }; reader.onerror = () => reject(new Error('Failed to read SVG file.')); reader.readAsDataURL(file); });

            const handleGeneration = async (imagesToProcess) => {
                if (isProcessing || imagesToProcess.length === 0) return;
                isProcessing = true;
                updateButtonStates();
                statusCounters.classList.remove('hidden');
                filterControls.classList.remove('hidden');
                actionsControls.classList.remove('hidden');
                filenameCsvControls.classList.remove('hidden');
                pauseBtn.classList.remove('hidden');
                resumeBtn.classList.add('hidden');
                let completedCount = 0;
                progressContainer.classList.remove('hidden');
                updateProgress(completedCount, imagesToProcess.length);
                const queue = [...imagesToProcess];
                const processImage = async () => {
                    while (queue.length > 0) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        while (isPaused) await new Promise(resolve => setTimeout(resolve, 500));
                        const imageToProcess = queue.shift();
                        if (imageToProcess) {
                            await generateMetadataForImage(imageToProcess);
                            completedCount++;
                            updateProgress(completedCount, imagesToProcess.length);
                            updateCounters();
                        }
                    }
                };
                const workers = Array.from({ length: CONCURRENCY_LIMIT }, processImage);
                await Promise.all(workers);
                isProcessing = false;
                isPaused = false;
                showToast('Processing complete!', 'success');
                actionsControls.classList.remove('hidden');
                filenameCsvControls.classList.remove('hidden');
                updateButtonStates();
                renderResults();
                setTimeout(() => { progressContainer.classList.add('hidden'); pauseBtn.classList.add('hidden'); resumeBtn.classList.add('hidden'); }, 2000);
            };

            const updateProgress = (completed, total) => { if (total === 0) return; const percent = Math.round((completed / total) * 100); progressBar.style.width = `${percent}%`; progressPercent.textContent = `${percent}%`; progressText.textContent = `Processing: ${completed} / ${total}`; };

            const generateMetadataForImage = async (img) => {
                try {
                    updateStatus(img.id, 'Generating...');
                    let fileToProcess = img.file;
                    if (img.file.type === 'image/svg+xml') { updateStatus(img.id, 'Converting SVG...'); fileToProcess = await convertSvgToPngBlob(img.file); updateStatus(img.id, 'Generating...'); }
                    const base64Data = await readFileAsBase64(fileToProcess);
                    const mimeType = fileToProcess.type;
                    const prompt = `You are an expert stock photo metadata creator for Adobe Stock. Analyze this image and provide a title, keywords, and a category ID.\n**Instructions:**\n1.  **Title:** A single, concise sentence. Maximum 200 characters.\n2.  **Keywords:** A comma-separated list of up to 49 relevant keywords.\n3.  **Category ID:** Choose the single best category ID from the following list that the image belongs to.\n    ${categoryListForPrompt}\n**Output Format:** Respond with ONLY a valid JSON object with three keys: "title", "keywords", and "category". The "category" value must be a number from the list.`;
                    const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: mimeType, data: base64Data } }] }], generation_config: { response_mime_type: "application/json" }, safety_settings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }] };
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (!response.ok || !result.candidates || result.candidates.length === 0) { const errorMessage = result.error?.message || (result.promptFeedback ? `Blocked: ${result.promptFeedback.blockReason}` : 'Unknown API error'); throw new Error(errorMessage); }
                    const contentText = result.candidates[0].content?.parts?.[0]?.text;
                    if (!contentText) { const blockReason = result.candidates[0].finishReason; throw new Error(`Generation failed. Reason: ${blockReason}`); }
                    const content = JSON.parse(contentText);
                    const finalTitle = (content.title || '').substring(0, 200);
                    const finalKeywords = (content.keywords || '').split(',').map(k => k.trim()).filter(Boolean).slice(0, 49).join(', ');
                    const finalFilename = finalTitle.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
                    const finalCategory = content.category || '';
                    results[img.id] = { title: finalTitle, keywords: finalKeywords, filename: finalFilename, category: finalCategory, status: 'Complete' };
                    updateStatus(img.id, 'Complete');
                    page.querySelector(`#title-${img.id}`).value = finalTitle;
                    page.querySelector(`#keywords-${img.id}`).value = finalKeywords;
                    page.querySelector(`#filename-${img.id}`).value = finalFilename;
                    page.querySelector(`#category-${img.id}`).value = finalCategory;
                } catch (error) {
                    console.error(`Failed to process ${img.file.name}:`, error);
                    results[img.id] = { title: '', keywords: '', filename: '', category: '', status: 'Error', errorMessage: error.message };
                    updateStatus(img.id, 'Error', error.message);
                }
            };

            const updateStatus = (id, status, errorMessage = '') => {
                const card = page.querySelector(`#card-${id}`); if (!card) return;
                const statusEl = card.querySelector(`#status-${id}`); if (!statusEl) return;
                if (!results[id]) results[id] = { title: '', keywords: '', filename: '', category: '' };
                results[id].status = status; results[id].errorMessage = errorMessage;
                statusEl.textContent = status;
                statusEl.className = 'text-sm font-medium';
                if (status === 'Complete') statusEl.classList.add('text-green-400');
                else if (status === 'Error') statusEl.classList.add('text-red-400');
                else if (status === 'Generating...' || status === 'Converting SVG...') statusEl.classList.add('text-blue-400', 'animate-pulse');
                else statusEl.classList.add('text-yellow-400');
                const existingError = card.querySelector('.error-message-box'); if (existingError) existingError.remove();
                if (status === 'Error' && errorMessage) { const errorDiv = document.createElement('div'); errorDiv.className = 'error-message-box mt-2 text-xs text-red-400 bg-red-900/50 p-2 rounded-md'; errorDiv.innerHTML = `<strong>Error:</strong> ${errorMessage}`; const keywordsEl = card.querySelector(`#keywords-${id}`); if (keywordsEl && keywordsEl.parentElement) keywordsEl.parentElement.appendChild(errorDiv); }
            };

            const getSuccessfulImages = () => imageFiles.filter(img => results[img.id]?.status === 'Complete');
            const getFailedImages = () => imageFiles.filter(img => results[img.id]?.status === 'Error');
            const getPendingImages = () => imageFiles.filter(img => !results[img.id] || results[img.id]?.status === 'Pending' || results[img.id]?.status === 'Error');
            const getSelectedImages = () => imageFiles.filter(img => img.selected);

            const handleSelectionChange = () => { page.querySelectorAll('.image-checkbox').forEach(cb => { const img = imageFiles.find(i => i.id === cb.dataset.id); if (img) img.selected = cb.checked; }); updateBulkActionState(); };
            const handleSelectAll = (e) => { const isChecked = e.target.checked; const visibleImageIds = Array.from(page.querySelectorAll('.image-checkbox')).map(cb => cb.dataset.id); imageFiles.forEach(img => { if (visibleImageIds.includes(img.id)) img.selected = isChecked; }); renderResults(); updateBulkActionState(); };
            const updateBulkActionState = () => { const selected = getSelectedImages(); deleteSelectedBtn.classList.toggle('btn-disabled', selected.length === 0); retrySelectedBtn.classList.toggle('btn-disabled', !(selected.length > 0 && selected.some(img => results[img.id]?.status === 'Error'))); };
            const handleRetrySelected = () => { const failedSelected = getSelectedImages().filter(img => results[img.id]?.status === 'Error'); if (failedSelected.length > 0) handleGeneration(failedSelected); else showToast('No failed images selected to retry.', 'info'); };
            const handleDeleteSelected = () => { const selectedIds = getSelectedImages().map(img => img.id); if (selectedIds.length === 0) { showToast('No images selected to delete.', 'info'); return; } openConfirmModal(`Are you sure you want to delete ${selectedIds.length} selected image(s)?`, () => { imageFiles = imageFiles.filter(img => !img.selected); selectedIds.forEach(id => delete results[id]); renderResults(); updateButtonStates(); closeConfirmModal(); showToast(`${selectedIds.length} image(s) deleted.`); }); };

            const handleCsvDownload = () => {
                const successfulImages = getSuccessfulImages();
                if (successfulImages.length === 0) { showToast('No successful images to download.', 'error'); return; }
                let csvContent = 'Filename,Title,Keywords,Category,Releases\n';
                successfulImages.forEach(img => { const result = results[img.id]; const extension = img.file.name.split('.').pop(); const filename = `${result.filename}.${extension}`; const title = `"${(result.title || '').replace(/"/g, '""')}"`; const keywords = `"${(result.keywords || '').replace(/"/g, '""')}"`; const category = result.category || ''; const releases = ''; csvContent += `${filename},${title},${keywords},${category},${releases}\n`; });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', 'adobe_stock_metadata.csv'); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('CSV for successful images downloaded!');
            };

            const handleFilenamesCsvDownload = () => {
                const successfulImages = getSuccessfulImages();
                if (successfulImages.length === 0) { showToast('No successful images to create a list from.', 'error'); return; }
                const selectedTypes = Array.from(page.querySelectorAll('.file-type-checkbox:checked')).map(cb => cb.value);
                if (selectedTypes.length === 0) { showToast('Please select at least one original file type to include.', 'info'); return; }
                const filteredImages = successfulImages.filter(img => { const originalExtension = `.${img.file.name.split('.').pop().toLowerCase()}`; return selectedTypes.includes(originalExtension); });
                if (filteredImages.length === 0) { showToast('No successful images match the selected file types.', 'info'); return; }
                const customExtension = customExtensionInput.value.trim();
                let csvContent = '';
                filteredImages.forEach(img => { const result = results[img.id]; let finalExtension; if (customExtension) finalExtension = customExtension.startsWith('.') ? customExtension.substring(1) : customExtension; else finalExtension = img.file.name.split('.').pop(); const filename = `${result.filename}.${finalExtension}`; csvContent += `${filename}\n`; });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', 'new_filenames.csv'); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast(`Filename CSV for ${filteredImages.length} image(s) downloaded!`);
            };

            const handleZipDownload = async () => {
                const successfulImages = getSuccessfulImages();
                if (successfulImages.length === 0) { showToast('No successful images to download.', 'error'); return; }
                downloadZipBtn.classList.add('btn-disabled'); startGenerationBtn.classList.add('btn-disabled'); downloadCsvBtn.classList.add('btn-disabled');
                progressContainer.classList.remove('hidden'); progressText.textContent = 'Zipping successful files...'; updateProgress(0, successfulImages.length);
                try {
                    const zip = new JSZip(); let filesAdded = 0;
                    for (const img of successfulImages) { const result = results[img.id]; const extension = img.file.name.split('.').pop(); const newFilename = `${result.filename}.${extension}`; zip.file(newFilename, img.file); filesAdded++; updateProgress(filesAdded, successfulImages.length); }
                    progressText.textContent = 'Generating zip file...'; const content = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a'); link.href = URL.createObjectURL(content); link.download = "ai_renamed_images.zip"; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
                    showToast('Zip file of successful images downloaded!');
                } catch (error) { console.error("Error creating zip file:", error); showToast('Failed to create zip file.', 'error'); } finally { updateButtonStates(); setTimeout(() => { progressContainer.classList.add('hidden'); updateProgress(0, 1); }, 2000); }
            };

            const handleFailedZipDownload = async () => {
                const failedImages = getFailedImages();
                if (failedImages.length === 0) { showToast('No failed images to download.', 'error'); return; }
                progressContainer.classList.remove('hidden'); progressText.textContent = 'Zipping failed files...'; updateProgress(0, failedImages.length);
                try {
                    const zip = new JSZip(); let filesAdded = 0;
                    for (const img of failedImages) { const extension = img.file.name.split('.').pop(); const newFilename = `failed-${filesAdded + 1}.${extension}`; zip.file(newFilename, img.file); filesAdded++; updateProgress(filesAdded, failedImages.length); }
                    progressText.textContent = 'Generating zip file...'; const content = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a'); link.href = URL.createObjectURL(content); link.download = "failed_images.zip"; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
                    showToast('Zip file of failed images downloaded!');
                } catch (error) { console.error("Error creating zip file:", error); showToast('Failed to create zip file.', 'error'); } finally { setTimeout(() => { progressContainer.classList.add('hidden'); updateProgress(0, 1); }, 2000); }
            };

            const handleClearSucceeded = () => {
                const successfulIds = getSuccessfulImages().map(img => img.id);
                imageFiles = imageFiles.filter(img => !successfulIds.includes(img.id));
                successfulIds.forEach(id => { delete results[id]; });
                showToast('Cleared all successful images.');
                currentFilter = 'all';
                page.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
                page.querySelector('.filter-btn[data-filter="all"]').classList.add('filter-btn-active');
                renderResults();
                updateButtonStates();
                if (imageFiles.length === 0) { statusCounters.classList.add('hidden'); filterControls.classList.add('hidden'); actionsControls.classList.add('hidden'); filenameCsvControls.classList.add('hidden'); }
            };
            init();
        })();

        // --- Footer Logic ---
        const bkashBtn = document.getElementById('bkash-support-btn');
        const copyToast = document.getElementById('copy-toast');
        if(bkashBtn) {
            bkashBtn.addEventListener('click', () => {
                const bkashNumber = '+8801815753403';
                const textArea = document.createElement('textarea');
                textArea.value = bkashNumber;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyToast.classList.remove('translate-x-[120%]');
                    setTimeout(() => {
                        copyToast.classList.add('translate-x-[120%]');
                    }, 3000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(textArea);
            });
        }
    });
    </script>
</body>
</html>
